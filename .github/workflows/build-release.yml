name: Build and Release

on:
  push:
    branches: [ main, develop ]
    tags: [ 'v*' ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:
    inputs:
      platforms:
        description: 'æ„å»ºå¹³å° (android,ios,web,macos,windows,linux)'
        required: false
        default: 'android,web'
      skip_tests:
        description: 'è·³è¿‡æµ‹è¯•'
        required: false
        default: false
        type: boolean

env:
  FLUTTER_VERSION: 'stable'
  CI: true
  CI_PLATFORM: github

jobs:
  # ä»£ç è´¨é‡æ£€æŸ¥
  quality-check:
    name: ä»£ç è´¨é‡æ£€æŸ¥
    runs-on: ubuntu-latest
    if: github.event.inputs.skip_tests != 'true'
    
    steps:
    - name: ğŸ“¥ æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
      
    - name: â˜• è®¾ç½®JDK
      uses: actions/setup-java@v3
      with:
        distribution: 'zulu'
        java-version: '17'
        
    - name: ğŸ“± è®¾ç½®Flutter
      uses: subosito/flutter-action@v2
      with:
        flutter-version: ${{ env.FLUTTER_VERSION }}
        cache: true
        
    - name: ğŸ“¦ è·å–ä¾èµ–
      run: flutter pub get
      
    - name: ğŸ” ä»£ç åˆ†æ
      run: flutter analyze
      
    - name: ğŸ“ ä»£ç æ ¼å¼æ£€æŸ¥
      run: dart format --set-exit-if-changed .
      
    - name: ğŸ§ª è¿è¡Œæµ‹è¯•
      run: |
        if [ -d "test" ]; then
          flutter test --coverage
        else
          echo "æœªæ‰¾åˆ°æµ‹è¯•ç›®å½•ï¼Œè·³è¿‡æµ‹è¯•"
        fi
        
    - name: ğŸ“Š ä¸Šä¼ ä»£ç è¦†ç›–ç‡
      if: hashFiles('coverage/lcov.info') != ''
      uses: codecov/codecov-action@v3
      with:
        file: coverage/lcov.info

  # Androidæ„å»º
  build-android:
    name: æ„å»ºAndroid
    runs-on: ubuntu-latest
    needs: quality-check
    if: always() && (needs.quality-check.result == 'success' || needs.quality-check.result == 'skipped')
    
    steps:
    - name: ğŸ“¥ æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
      
    - name: â˜• è®¾ç½®JDK
      uses: actions/setup-java@v3
      with:
        distribution: 'zulu'
        java-version: '17'
        
    - name: ğŸ“± è®¾ç½®Flutter
      uses: subosito/flutter-action@v2
      with:
        flutter-version: ${{ env.FLUTTER_VERSION }}
        cache: true
        
    - name: ğŸ“¦ è·å–ä¾èµ–
      run: flutter pub get
      
    - name: ğŸ”§ è®¾ç½®Androidç­¾å
      if: github.event_name == 'push' && startsWith(github.ref, 'refs/tags/')
      env:
        ANDROID_KEYSTORE: ${{ secrets.ANDROID_KEYSTORE }}
        ANDROID_KEYSTORE_PASSWORD: ${{ secrets.ANDROID_KEYSTORE_PASSWORD }}
        ANDROID_KEY_PASSWORD: ${{ secrets.ANDROID_KEY_PASSWORD }}
        ANDROID_KEY_ALIAS: ${{ secrets.ANDROID_KEY_ALIAS }}
      run: |
        if [ -n "$ANDROID_KEYSTORE" ]; then
          echo "$ANDROID_KEYSTORE" | base64 --decode > android/app/key.jks
          echo "storePassword=$ANDROID_KEYSTORE_PASSWORD" >> android/key.properties
          echo "keyPassword=$ANDROID_KEY_PASSWORD" >> android/key.properties
          echo "keyAlias=$ANDROID_KEY_ALIAS" >> android/key.properties
          echo "storeFile=key.jks" >> android/key.properties
        fi
        
    - name: ğŸ—ï¸ æ„å»ºAPK
      run: flutter build apk --release --split-per-abi
      
    - name: ğŸ—ï¸ æ„å»ºAAB
      run: flutter build appbundle --release
      
    - name: ğŸ“¦ æ‰“åŒ…Androidæ„å»ºäº§ç‰©
      run: |
        mkdir -p artifacts/android
        cp build/app/outputs/flutter-apk/*.apk artifacts/android/ || true
        cp build/app/outputs/bundle/release/*.aab artifacts/android/ || true
        
    - name: ğŸ“¤ ä¸Šä¼ Androidæ„å»ºäº§ç‰©
      uses: actions/upload-artifact@v3
      with:
        name: android-build
        path: artifacts/android/
        retention-days: 30

  # iOSæ„å»º (ä»…åœ¨macOSä¸Š)
  build-ios:
    name: æ„å»ºiOS
    runs-on: macos-latest
    needs: quality-check
    if: always() && (needs.quality-check.result == 'success' || needs.quality-check.result == 'skipped') && (contains(github.event.inputs.platforms, 'ios') || github.event_name == 'push')
    
    steps:
    - name: ğŸ“¥ æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
      
    - name: ğŸ“± è®¾ç½®Flutter
      uses: subosito/flutter-action@v2
      with:
        flutter-version: ${{ env.FLUTTER_VERSION }}
        cache: true
        
    - name: ğŸ“¦ è·å–ä¾èµ–
      run: flutter pub get
      
    - name: ğŸ è®¾ç½®iOSç¯å¢ƒ
      run: |
        sudo xcode-select -s /Applications/Xcode.app/Contents/Developer
        flutter config --enable-ios
        
    - name: ğŸ”§ è®¾ç½®iOSç­¾å (å¦‚æœæœ‰è¯ä¹¦)
      if: github.event_name == 'push' && startsWith(github.ref, 'refs/tags/')
      env:
        IOS_CERTIFICATE: ${{ secrets.IOS_CERTIFICATE }}
        IOS_CERTIFICATE_PASSWORD: ${{ secrets.IOS_CERTIFICATE_PASSWORD }}
        IOS_KEYCHAIN_PASSWORD: ${{ secrets.IOS_KEYCHAIN_PASSWORD }}
        IOS_PROVISIONING_PROFILE: ${{ secrets.IOS_PROVISIONING_PROFILE }}
      run: |
        if [ -n "$IOS_CERTIFICATE" ]; then
          # åˆ›å»ºä¸´æ—¶å¯†é’¥é“¾
          security create-keychain -p "$IOS_KEYCHAIN_PASSWORD" build.keychain
          security default-keychain -s build.keychain
          security unlock-keychain -p "$IOS_KEYCHAIN_PASSWORD" build.keychain
          
          # å¯¼å…¥è¯ä¹¦
          echo "$IOS_CERTIFICATE" | base64 --decode > certificate.p12
          security import certificate.p12 -k build.keychain -P "$IOS_CERTIFICATE_PASSWORD" -T /usr/bin/codesign
          
          # å¯¼å…¥æè¿°æ–‡ä»¶
          echo "$IOS_PROVISIONING_PROFILE" | base64 --decode > profile.mobileprovision
          mkdir -p ~/Library/MobileDevice/Provisioning\ Profiles
          cp profile.mobileprovision ~/Library/MobileDevice/Provisioning\ Profiles/
        fi
        
    - name: ğŸ—ï¸ æ„å»ºiOS
      env:
        IOS_CERTIFICATE: ${{ secrets.IOS_CERTIFICATE }}
      run: |
        if [ -n "$IOS_CERTIFICATE" ]; then
          flutter build ipa --release
        else
          flutter build ios --release --no-codesign
        fi
        
    - name: ğŸ“¦ æ‰“åŒ…iOSæ„å»ºäº§ç‰©
      run: |
        mkdir -p artifacts/ios
        if [ -d "build/ios/ipa" ]; then
          cp build/ios/ipa/*.ipa artifacts/ios/ || true
        fi
        if [ -d "build/ios/iphoneos/Runner.app" ]; then
          cp -r build/ios/iphoneos/Runner.app artifacts/ios/
        fi
        
    - name: ğŸ“¤ ä¸Šä¼ iOSæ„å»ºäº§ç‰©
      uses: actions/upload-artifact@v3
      with:
        name: ios-build
        path: artifacts/ios/
        retention-days: 30

  # Webæ„å»º
  build-web:
    name: æ„å»ºWeb
    runs-on: ubuntu-latest
    needs: quality-check
    if: always() && (needs.quality-check.result == 'success' || needs.quality-check.result == 'skipped')
    
    steps:
    - name: ğŸ“¥ æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
      
    - name: ğŸ“± è®¾ç½®Flutter
      uses: subosito/flutter-action@v2
      with:
        flutter-version: ${{ env.FLUTTER_VERSION }}
        cache: true
        
    - name: ğŸ“¦ è·å–ä¾èµ–
      run: flutter pub get
      
    - name: ğŸŒ å¯ç”¨Webæ”¯æŒ
      run: flutter config --enable-web
      
    - name: ğŸ—ï¸ æ„å»ºWeb
      run: flutter build web --release
      
    - name: ğŸ“¦ æ‰“åŒ…Webæ„å»ºäº§ç‰©
      run: |
        mkdir -p artifacts
        cp -r build/web artifacts/
        cd artifacts
        tar -czf alouette-tts-web.tar.gz web/
        
    - name: ğŸ“¤ ä¸Šä¼ Webæ„å»ºäº§ç‰©
      uses: actions/upload-artifact@v3
      with:
        name: web-build
        path: artifacts/
        retention-days: 30
        
    - name: ğŸš€ éƒ¨ç½²åˆ°GitHub Pages (ä»…ä¸»åˆ†æ”¯)
      if: github.ref == 'refs/heads/main' && github.event_name == 'push'
      uses: peaceiris/actions-gh-pages@v3
      with:
        github_token: ${{ secrets.GITHUB_TOKEN }}
        publish_dir: build/web

  # macOSæ„å»º
  build-macos:
    name: æ„å»ºmacOS
    runs-on: macos-latest
    needs: quality-check
    if: always() && (needs.quality-check.result == 'success' || needs.quality-check.result == 'skipped') && contains(github.event.inputs.platforms, 'macos')
    
    steps:
    - name: ğŸ“¥ æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
      
    - name: ğŸ“± è®¾ç½®Flutter
      uses: subosito/flutter-action@v2
      with:
        flutter-version: ${{ env.FLUTTER_VERSION }}
        cache: true
        
    - name: ğŸ“¦ è·å–ä¾èµ–
      run: flutter pub get
      
    - name: ğŸ–¥ï¸ å¯ç”¨macOSæ”¯æŒ
      run: flutter config --enable-macos-desktop
      
    - name: ğŸ—ï¸ æ„å»ºmacOS
      run: flutter build macos --release
      
    - name: ğŸ“¦ æ‰“åŒ…macOSæ„å»ºäº§ç‰©
      run: |
        mkdir -p artifacts/macos
        cp -r build/macos/Build/Products/Release/*.app artifacts/macos/
        
        # åˆ›å»ºDMG (å¦‚æœéœ€è¦)
        cd artifacts/macos
        if [ -d "*.app" ]; then
          hdiutil create -volname "Alouette TTS" -srcfolder *.app -ov -format UDZO ../alouette-tts-macos.dmg
        fi
        
    - name: ğŸ“¤ ä¸Šä¼ macOSæ„å»ºäº§ç‰©
      uses: actions/upload-artifact@v3
      with:
        name: macos-build
        path: artifacts/
        retention-days: 30

  # Windowsæ„å»º
  build-windows:
    name: æ„å»ºWindows
    runs-on: windows-latest
    needs: quality-check
    if: always() && (needs.quality-check.result == 'success' || needs.quality-check.result == 'skipped') && contains(github.event.inputs.platforms, 'windows')
    
    steps:
    - name: ğŸ“¥ æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
      
    - name: ğŸ“± è®¾ç½®Flutter
      uses: subosito/flutter-action@v2
      with:
        flutter-version: ${{ env.FLUTTER_VERSION }}
        cache: true
        
    - name: ğŸ“¦ è·å–ä¾èµ–
      run: flutter pub get
      
    - name: ğŸ–¥ï¸ å¯ç”¨Windowsæ”¯æŒ
      run: flutter config --enable-windows-desktop
      
    - name: ğŸ—ï¸ æ„å»ºWindows
      run: flutter build windows --release
      
    - name: ğŸ“¦ æ‰“åŒ…Windowsæ„å»ºäº§ç‰©
      run: |
        mkdir artifacts
        xcopy "build\windows\x64\runner\Release" "artifacts\windows" /E /I /Y
        cd artifacts
        7z a alouette-tts-windows.zip windows\
        
    - name: ğŸ“¤ ä¸Šä¼ Windowsæ„å»ºäº§ç‰©
      uses: actions/upload-artifact@v3
      with:
        name: windows-build
        path: artifacts/
        retention-days: 30

  # Linuxæ„å»º
  build-linux:
    name: æ„å»ºLinux
    runs-on: ubuntu-latest
    needs: quality-check
    if: always() && (needs.quality-check.result == 'success' || needs.quality-check.result == 'skipped') && contains(github.event.inputs.platforms, 'linux')
    
    steps:
    - name: ğŸ“¥ æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
      
    - name: ğŸ”§ å®‰è£…Linuxæ¡Œé¢ä¾èµ–
      run: |
        sudo apt-get update
        sudo apt-get install -y clang cmake ninja-build pkg-config libgtk-3-dev liblzma-dev
        
    - name: ğŸ“± è®¾ç½®Flutter
      uses: subosito/flutter-action@v2
      with:
        flutter-version: ${{ env.FLUTTER_VERSION }}
        cache: true
        
    - name: ğŸ“¦ è·å–ä¾èµ–
      run: flutter pub get
      
    - name: ğŸ–¥ï¸ å¯ç”¨Linuxæ”¯æŒ
      run: flutter config --enable-linux-desktop
      
    - name: ğŸ—ï¸ æ„å»ºLinux
      run: flutter build linux --release
      
    - name: ğŸ“¦ æ‰“åŒ…Linuxæ„å»ºäº§ç‰©
      run: |
        mkdir -p artifacts
        cp -r build/linux/x64/release/bundle artifacts/linux
        cd artifacts
        tar -czf alouette-tts-linux.tar.gz linux/
        
    - name: ğŸ“¤ ä¸Šä¼ Linuxæ„å»ºäº§ç‰©
      uses: actions/upload-artifact@v3
      with:
        name: linux-build
        path: artifacts/
        retention-days: 30

  # åˆ›å»ºå‘å¸ƒ
  create-release:
    name: åˆ›å»ºå‘å¸ƒ
    runs-on: ubuntu-latest
    needs: [build-android, build-web]
    if: github.event_name == 'push' && startsWith(github.ref, 'refs/tags/')
    
    steps:
    - name: ğŸ“¥ æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
      
    - name: ğŸ“¥ ä¸‹è½½æ‰€æœ‰æ„å»ºäº§ç‰©
      uses: actions/download-artifact@v3
      with:
        path: artifacts/
        
    - name: ğŸ“ ç”Ÿæˆå‘å¸ƒè¯´æ˜
      run: |
        echo "# Alouette TTS ${GITHUB_REF#refs/tags/}" > RELEASE_NOTES.md
        echo "" >> RELEASE_NOTES.md
        echo "## æ„å»ºäº§ç‰©" >> RELEASE_NOTES.md
        echo "" >> RELEASE_NOTES.md
        find artifacts -name "*.apk" -o -name "*.aab" -o -name "*.ipa" -o -name "*.tar.gz" -o -name "*.zip" -o -name "*.dmg" | while read file; do
          size=$(ls -lh "$file" | awk '{print $5}')
          echo "- $(basename "$file") (${size})" >> RELEASE_NOTES.md
        done
        
    - name: ğŸ·ï¸ åˆ›å»ºå‘å¸ƒ
      uses: softprops/action-gh-release@v1
      with:
        body_path: RELEASE_NOTES.md
        files: |
          artifacts/**/*.apk
          artifacts/**/*.aab
          artifacts/**/*.ipa
          artifacts/**/*.tar.gz
          artifacts/**/*.zip
          artifacts/**/*.dmg
        draft: false
        prerelease: ${{ contains(github.ref, 'beta') || contains(github.ref, 'alpha') }}
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
